VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "Sheet1"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = True
Option Explicit

' 手順：
' Step1: アンケート回答（Word）をすべてExcelに集計する
' Step2: 集計結果を、提出フォーマットに追記 & アンケート回答関連ファイルを対応IDにリネーム


Sub executeStep1()
    Dim strBaseDataFolderName As String
    strBaseDataFolderName = "data"
    
    ' アンケート回答
    Dim strQuestionnaireFolderName As String
    strQuestionnaireFolderName = "questionnaire"
    
    ' アンケート集計
    Dim strQuestionnaireTotalFolderName As String
    strQuestionnaireTotalFolderName = "total"
    Dim strQuestionnaireTotalFileName As String
    strQuestionnaireTotalFileName = "questionnaire-total.xlsx"
    
    
    Dim strQuestionnaireFolderPath As String
    strQuestionnaireFolderPath = strBaseDataFolderName & "\" & strQuestionnaireFolderName
    Dim strQuestionnaireTotalFolderPath As String
    strQuestionnaireTotalFolderPath = strBaseDataFolderName & "\" & strQuestionnaireTotalFolderName

    Call aggregatesyuukeiQuestionnaire(strQuestionnaireFolderPath, strQuestionnaireTotalFolderPath, strQuestionnaireTotalFileName)
End Sub

Sub aggregatesyuukeiQuestionnaire(strQuestionnaireFolderPath As String, strQuestionnaireTotalFolderPath As String, strQuestionnaireTotalFileName As String)
    Dim strQuestionnaireTotalFilePath As String
    strQuestionnaireTotalFilePath = ThisWorkbook.Path & "\" & strQuestionnaireTotalFolderPath & "\" & strQuestionnaireTotalFileName

    Dim xlApp As Excel.Application
    Dim xlWookbook As Excel.Workbook
    Dim xlSheet As Excel.Worksheet
    Set xlApp = CreateObject("Excel.Application")
    xlApp.Visible = True
    'Set xlWookbook = xlApp.Workbooks.Add()
    Set xlWookbook = xlApp.Workbooks.Open(strQuestionnaireTotalFilePath)
    Set xlSheet = xlWookbook.Sheets(1)
    
    
    Dim wordFiles As String
    wordFiles = ThisWorkbook.Path & "\" & strQuestionnaireFolderPath & "\*.docx"

    Dim fileName As String
    fileName = Dir(wordFiles)

    Dim i As Integer
    i = 2
    Do While fileName <> ""
        Dim wordFile As String
        wordFile = ThisWorkbook.Path & "\" & strQuestionnaireFolderPath & "\" & fileName
        
        Dim wdApp As Word.Application
        Dim wdDoc As Word.Document
        Set wdApp = CreateObject("Word.Application")
        wdApp.Visible = True
        Set wdDoc = wdApp.Documents.Open(wordFile)
        
        Dim countTables As Integer
        countTables = wdDoc.Tables.Count
        If countTables = 6 Then
            Dim name As String
            name = wdDoc.Tables(1).Range.Cells(2).Range.Text
            Dim sname As String
            sname = Replace(name, "　", "")
            sname = Replace(sname, " ", "")
            Dim department As String
            department = wdDoc.Tables(2).Range.Cells(2).Range.Text
            Dim question1 As String
            question1 = wdDoc.Tables(3).Range.Cells(1).Range.Text
            Dim question2 As String
            question2 = wdDoc.Tables(4).Range.Cells(1).Range.Text
            Dim question3 As String
            question3 = wdDoc.Tables(5).Range.Cells(1).Range.Text
            Dim question4 As String
            question4 = wdDoc.Tables(6).Range.Cells(1).Range.Text
            
            Dim fileNo As String
            Dim tmp As Variant
            tmp = Split(fileName, "-")
            fileNo = tmp(0)
            
            Dim fileName2 As String
            fileName2 = FileSearch(ThisWorkbook.Path & "\" & strQuestionnaireFolderPath, fileName, fileNo & "-*")
            
            xlSheet.Cells(i, 1) = sname
            xlSheet.Cells(i, 2) = department
            xlSheet.Cells(i, 3) = name
            xlSheet.Cells(i, 4) = question1
            xlSheet.Cells(i, 5) = question2
            xlSheet.Cells(i, 6) = question3
            xlSheet.Cells(i, 7) = question4
            xlSheet.Cells(i, 8) = fileNo
            xlSheet.Cells(i, 9) = fileName
            xlSheet.Cells(i, 10) = fileName2
            
            i = i + 1
        End If
        
        If countTables = 5 Then
            
        End If
      
        wdDoc.Close
        Call wdApp.Quit
        Set wdApp = Nothing
        
        fileName = Dir()
    Loop

    xlApp.DisplayAlerts = False
    xlWookbook.Save
    xlWookbook.Close
    xlApp.DisplayAlerts = True
    Call xlApp.Quit
    Set xlApp = Nothing
End Sub


Function FileSearch(strPath As String, strTargetWord As String, strTargetOther As String)
    Dim strFileName As String
    Dim FSO As Object, File As Variant
    Set FSO = CreateObject("Scripting.FileSystemObject")
    For Each File In FSO.GetFolder(strPath).Files
        If File.name Like strTargetWord Then
            GoTo Continue
        End If
        If File.name Like strTargetOther Then
            strFileName = File.name
            Exit For
        End If
Continue:
    Next File
    
    FileSearch = strFileName
End Function
